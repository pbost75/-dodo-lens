<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ Test Extraction Frames Mobile</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #1a1a1a; color: #fff; }
        .container { background: #2a2a2a; padding: 30px; border-radius: 10px; }
        h1 { color: #4CAF50; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .info { background: #2196F3; color: white; }
        .warning { background: #ff9800; color: white; }
        button { background: #4CAF50; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 5px; cursor: pointer; width: 100%; margin: 10px 0; }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .result { background: #333; padding: 15px; border-radius: 5px; margin: 20px 0; white-space: pre-wrap; font-family: monospace; }
        .logs { background: #1a1a1a; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .frame-preview { max-width: 100%; border-radius: 5px; margin: 10px 0; }
        #videoPreview { width: 100%; max-width: 400px; border-radius: 5px; margin: 10px 0; background: #000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Test Extraction Frames Mobile</h1>
        
        <div id="status" class="status info">
            ğŸ”„ PrÃªt pour test extraction de frames
        </div>
        
        <video id="videoPreview" autoplay muted playsinline style="display: none;"></video>
        
        <button id="recordBtn" onclick="startRecording()">ğŸ¥ Enregistrer VidÃ©o (5s)</button>
        <button id="stopBtn" onclick="stopRecording()" disabled style="background: #f44336;">â¹ï¸ ArrÃªter Enregistrement</button>
        <button id="analyzeBtn" onclick="extractFrame()" disabled>ğŸ“¸ Extraire Frame</button>
        
        <div id="result" class="result" style="display: none;"></div>
        <img id="framePreview" class="frame-preview" style="display: none;" />
        <div id="logs" class="logs"></div>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let videoBlob = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        let currentStream = null;
        
        async function startRecording() {
            log('ğŸ¥ DÃ©marrage enregistrement vidÃ©o...');
            updateStatus('ğŸ¥ AccÃ¨s camÃ©ra...', 'warning');
            
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 360 },
                        facingMode: 'environment' // CamÃ©ra arriÃ¨re sur mobile
                    },
                    audio: false 
                });
                
                // Afficher la prÃ©visualisation
                const videoPreview = document.getElementById('videoPreview');
                videoPreview.srcObject = currentStream;
                videoPreview.style.display = 'block';
                
                log('âœ… CamÃ©ra accessible et prÃ©visualisation activÃ©e');
                updateStatus('ğŸ”´ Enregistrement en cours...', 'error');
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(currentStream, {
                    mimeType: 'video/webm;codecs=vp9' // Format mobile-friendly
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        log(`ğŸ“¦ Chunk vidÃ©o reÃ§u: ${event.data.size} bytes`);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    log('â¹ï¸ Enregistrement arrÃªtÃ©');
                    videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                    log(`ğŸ“¹ VidÃ©o crÃ©Ã©e: ${videoBlob.size} bytes`);
                    
                    // ArrÃªter la camÃ©ra
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        document.getElementById('videoPreview').style.display = 'none';
                    }
                    
                    // Activer l'extraction
                    document.getElementById('recordBtn').disabled = false;
                    document.getElementById('analyzeBtn').disabled = false;
                    updateStatus('ğŸ“¸ PrÃªt pour extraction frame', 'success');
                };
                
                mediaRecorder.start();
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
            } catch (error) {
                log(`âŒ Erreur camÃ©ra: ${error.message}`);
                updateStatus('âŒ Erreur accÃ¨s camÃ©ra', 'error');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                log('â¹ï¸ ArrÃªt manuel de l\'enregistrement');
                mediaRecorder.stop();
            }
            
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
        
        async function extractFrame() {
            if (!videoBlob) {
                log('âŒ Pas de vidÃ©o enregistrÃ©e');
                return;
            }
            
            log('ğŸ“¸ DÃ©but extraction frame native...');
            updateStatus('ğŸ“¸ Extraction frame...', 'warning');
            
            const startTime = Date.now();
            
            try {
                // MÃ©thode native JavaScript (comme dans votre app)
                const video = document.createElement('video');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                if (!context) {
                    throw new Error('Canvas context non disponible');
                }
                
                video.preload = 'metadata';
                video.muted = true;
                video.playsInline = true;
                video.crossOrigin = 'anonymous';
                
                const extractPromise = new Promise((resolve, reject) => {
                    let frameExtracted = false;
                    
                    const timeout = setTimeout(() => {
                        if (!frameExtracted) {
                            reject(new Error('Timeout extraction frame (10s)'));
                        }
                    }, 10000);
                    
                    const doExtraction = () => {
                        if (frameExtracted) return;
                        
                        try {
                            log(`ğŸ“ Dimensions vidÃ©o: ${video.videoWidth}x${video.videoHeight}`);
                            log(`â±ï¸ DurÃ©e: ${video.duration}s, Position: ${video.currentTime}s`);
                            
                            canvas.width = Math.min(video.videoWidth || 640, 640);
                            canvas.height = Math.min(video.videoHeight || 360, 360);
                            
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const frameData = canvas.toDataURL('image/jpeg', 0.8);
                            
                            frameExtracted = true;
                            clearTimeout(timeout);
                            
                            const processingTime = Date.now() - startTime;
                            log(`âœ… Frame extraite en ${processingTime}ms`);
                            
                            resolve({
                                success: true,
                                frameData,
                                processingTime,
                                dimensions: `${canvas.width}x${canvas.height}`
                            });
                        } catch (error) {
                            frameExtracted = true;
                            clearTimeout(timeout);
                            reject(error);
                        }
                    };
                    
                    video.onloadedmetadata = () => {
                        log(`ğŸ“Š MÃ©tadonnÃ©es chargÃ©es: ${video.videoWidth}x${video.videoHeight}, ${video.duration}s`);
                        
                        if (!isFinite(video.duration) || video.duration <= 0) {
                            log('âš ï¸ DurÃ©e invalide sur mobile, forÃ§age position 0...');
                            // Sur mobile, forcer l'extraction au dÃ©but
                            video.currentTime = 0;
                            return;
                        }
                        
                        // Positionner au milieu normalement
                        video.currentTime = Math.min(1, video.duration / 2);
                    };
                    
                    video.onseeked = () => {
                        log('ğŸ¯ Position vidÃ©o atteinte, extraction...');
                        doExtraction();
                    };
                    
                    video.oncanplay = () => {
                        log('â–¶ï¸ VidÃ©o prÃªte Ã  jouer');
                        if (!frameExtracted) {
                            setTimeout(() => doExtraction(), 100); // Petit dÃ©lai pour mobile
                        }
                    };
                    
                    video.onerror = (e) => {
                        log(`âŒ Erreur vidÃ©o: ${e.message || 'Erreur inconnue'}`);
                        frameExtracted = true;
                        clearTimeout(timeout);
                        reject(new Error('Erreur chargement vidÃ©o'));
                    };
                });
                
                // DÃ©marrer le processus
                video.src = URL.createObjectURL(videoBlob);
                log('ğŸ¬ URL vidÃ©o crÃ©Ã©e, chargement...');
                video.load();
                
                const result = await extractPromise;
                
                // Afficher les rÃ©sultats
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').textContent = 
                    `ğŸ‰ EXTRACTION RÃ‰USSIE!\n\n` +
                    `â±ï¸ Temps: ${result.processingTime}ms\n` +
                    `ğŸ“ Dimensions: ${result.dimensions}\n` +
                    `ğŸ“Š Taille vidÃ©o: ${videoBlob.size} bytes`;
                
                // Afficher la frame
                const framePreview = document.getElementById('framePreview');
                framePreview.src = result.frameData;
                framePreview.style.display = 'block';
                
                updateStatus('ğŸ‰ Frame extraite avec succÃ¨s!', 'success');
                
            } catch (error) {
                log(`âŒ Erreur extraction: ${error.message}`);
                
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').textContent = `âŒ Erreur extraction:\n${error.message}`;
                
                updateStatus('âŒ Erreur extraction frame', 'error');
            }
        }
        
        log('ğŸ¬ Page de test frames chargÃ©e');
        log(`ğŸ“± User Agent: ${navigator.userAgent}`);
        log(`ğŸ¥ MediaRecorder supportÃ©: ${!!window.MediaRecorder}`);
    </script>
</body>
</html>
